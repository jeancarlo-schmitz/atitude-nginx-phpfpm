#!/bin/bash
set -euo pipefail

# FunÃ§Ã£o auxiliar para imprimir seÃ§Ãµes destacadas
function section() {
  echo -e "\nğŸ”¹ \033[1;36m$1\033[0m"
}

section "ğŸ”» Parando containers..."
docker-compose down || true

section "ğŸ§¹ Limpando containers parados..."
docker container prune -f || true

section "ğŸ§¹ Removendo imagem antiga do PHP..."
old_image_id=$(docker images | grep docker-ngix-phpfpm_php | awk '{print $3}' || true)
if [ -n "$old_image_id" ]; then
  docker image rm "$old_image_id" || true
else
  echo "â„¹ï¸ Nenhuma imagem antiga encontrada."
fi

section "ğŸ”¨ Rebuildando imagem PHP sem cache..."
docker-compose build --no-cache php

section "ğŸš€ Subindo containers..."
docker-compose up -d

section "ğŸ§¾ Verificando consistÃªncia do composer.json e composer.lock..."
# Valida o composer.json e compara hash do lock
docker-compose run --rm php composer validate --no-check-all --strict || {
  echo "âŒ composer.json invÃ¡lido. Corrija antes de prosseguir."
  exit 1
}

# Detecta se o composer.lock estÃ¡ desatualizado em relaÃ§Ã£o ao composer.json
if docker-compose run --rm php composer install --dry-run 2>&1 | grep -q "lock file is not up to date"; then
  section "âš ï¸ composer.lock desatualizado â€” rodando composer update..."
  docker-compose run --rm php composer update --no-dev --optimize-autoloader
else
  section "ğŸ› ï¸ Rodando composer install..."
  docker-compose run --rm php composer install --no-dev --optimize-autoloader
fi

section "ğŸ§¹ Otimizando autoload..."
docker-compose run --rm php composer dump-autoload --optimize

section "âœ… Containers ativos:"
docker ps
