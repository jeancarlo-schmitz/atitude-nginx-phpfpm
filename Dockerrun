#!/bin/bash
set -e

echo "🔻 Parando e removendo containers..."
docker-compose down

echo "🧹 Limpando containers parados..."
docker container prune -f

echo "🧹 Removendo imagens antigas do nginx e php..."
docker image rm $(docker images | grep docker-ngix-phpfpm_nginx | awk '{print $3}') || true
docker image rm $(docker images | grep docker-ngix-phpfpm_php | awk '{print $3}') || true

echo "🔨 Rebuild forçado de nginx e php..."
docker-compose build --no-cache nginx php

echo "🚀 Subindo containers novamente..."
docker-compose up -d

echo "🛠️ Rodando composer install no container PHP..."
docker-compose run --rm php composer install --no-dev --optimize-autoloader

echo "✅ Containers ativos:"
docker ps
